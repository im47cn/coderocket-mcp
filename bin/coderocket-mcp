#!/usr/bin/env node

/**
 * CodeRocket MCP ç‹¬ç«‹å¯åŠ¨è„šæœ¬
 *
 * ç¬¦åˆ MCP æ ‡å‡†ï¼Œç›´æ¥å¯åŠ¨æœåŠ¡å™¨ï¼Œæ— éœ€é¢å¤–å‚æ•°
 */

import { resolve, dirname } from 'path';
import { fileURLToPath } from 'url';
import { readFileSync } from 'fs';

const __filename = fileURLToPath(import.meta.url);
const __dirname = dirname(__filename);

const command = process.argv[2];

// å¦‚æœæ²¡æœ‰å‘½ä»¤æˆ–å‘½ä»¤æ˜¯ startï¼Œç›´æ¥å¯åŠ¨ MCP æœåŠ¡å™¨
if (!command || command === 'start') {
  // ç›´æ¥å¯¼å…¥å¹¶å¯åŠ¨ MCP æœåŠ¡å™¨ï¼ˆä¸ä½¿ç”¨ spawnï¼‰
  const serverPath = resolve(__dirname, '../dist/index.js');

  try {
    // åŠ¨æ€å¯¼å…¥æœåŠ¡å™¨æ¨¡å—å¹¶å¯åŠ¨
    import(serverPath).catch((error) => {
      console.error('âŒ CodeRocket MCP æœåŠ¡å™¨å¯åŠ¨å¤±è´¥:', error.message);
      process.exit(1);
    });
  } catch (error) {
    console.error('âŒ æ— æ³•åŠ è½½ CodeRocket MCP æœåŠ¡å™¨:', error.message);
    process.exit(1);
  }
} else {
  // å¤„ç†å…¶ä»–å‘½ä»¤
  switch (command) {

    case 'test':
      // è¿è¡Œæµ‹è¯•
      console.error('ğŸ§ª è¿è¡Œ CodeRocket MCP æµ‹è¯•...');
      const testPath = resolve(__dirname, '../dist/test.js');

      try {
        import(testPath).catch((error) => {
          console.error('âŒ æµ‹è¯•è¿è¡Œå¤±è´¥:', error.message);
          process.exit(1);
        });
      } catch (error) {
        console.error('âŒ æ— æ³•åŠ è½½æµ‹è¯•æ¨¡å—:', error.message);
        process.exit(1);
      }
      break;

    case 'help':
    case '--help':
    case '-h':
      console.log(`
CodeRocket MCP - ç‹¬ç«‹çš„AIé©±åŠ¨ä»£ç å®¡æŸ¥æœåŠ¡å™¨

ç”¨æ³•:
  npx @yeepay/coderocket-mcp [å‘½ä»¤]

å‘½ä»¤:
  (é»˜è®¤)               å¯åŠ¨MCPæœåŠ¡å™¨
  test                 è¿è¡ŒåŠŸèƒ½æµ‹è¯•
  help                 æ˜¾ç¤ºå¸®åŠ©ä¿¡æ¯
  version              æ˜¾ç¤ºç‰ˆæœ¬ä¿¡æ¯

ç¤ºä¾‹:
  npx @yeepay/coderocket-mcp        # å¯åŠ¨æœåŠ¡å™¨
  npx @yeepay/coderocket-mcp test   # è¿è¡Œæµ‹è¯•
  npx @yeepay/coderocket-mcp help   # æ˜¾ç¤ºå¸®åŠ©

ç¯å¢ƒå˜é‡é…ç½®:
  AI_SERVICE              é»˜è®¤AIæœåŠ¡ (gemini/claudecode)
  AI_AUTO_SWITCH          å¯ç”¨è‡ªåŠ¨åˆ‡æ¢ (true/false)
  AI_TIMEOUT              è¶…æ—¶æ—¶é—´ï¼ˆç§’ï¼Œé»˜è®¤30ï¼‰
  AI_MAX_RETRIES          æœ€å¤§é‡è¯•æ¬¡æ•°ï¼ˆé»˜è®¤3ï¼‰
  GEMINI_API_KEY          Gemini APIå¯†é’¥
  CLAUDECODE_API_KEY      ClaudeCode APIå¯†é’¥
  NODE_ENV                ç¯å¢ƒæ¨¡å¼ (development/production)
  DEBUG                   è°ƒè¯•æ¨¡å¼ (true/false)

é…ç½®æ–‡ä»¶:
  é¡¹ç›®çº§: .env
  å…¨å±€çº§: ~/.coderocket/env

æ›´å¤šä¿¡æ¯è¯·è®¿é—®: https://github.com/im47cn/coderocket-mcp
`);
      break;

    case 'version':
    case '--version':
    case '-v':
      // è¯»å–package.jsonè·å–ç‰ˆæœ¬ä¿¡æ¯
      try {
        const packagePath = resolve(__dirname, '../package.json');
        const packageJson = JSON.parse(
          readFileSync(packagePath, 'utf-8')
        );
        console.log(`CodeRocket MCP v${packageJson.version}`);
        console.log(`ç‹¬ç«‹ç‰ˆæœ¬ - æ— éœ€ coderocket-cli ä¾èµ–`);
      } catch (error) {
        console.log('CodeRocket MCP v1.0.1 (ç‹¬ç«‹ç‰ˆæœ¬)');
      }
      break;

    default:
      console.error(`âŒ æœªçŸ¥å‘½ä»¤: ${command}`);
      console.error('ä½¿ç”¨ "npx @yeepay/coderocket-mcp help" æŸ¥çœ‹å¯ç”¨å‘½ä»¤');
      process.exit(1);
  }
}
