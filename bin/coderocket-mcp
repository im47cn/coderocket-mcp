#!/usr/bin/env node

/**
 * CodeRocket MCP å¯åŠ¨è„šæœ¬
 */

import { spawn } from 'child_process';
import { resolve, dirname } from 'path';
import { fileURLToPath } from 'url';

const __filename = fileURLToPath(import.meta.url);
const __dirname = dirname(__filename);

const command = process.argv[2];

switch (command) {
  case 'start':
  case undefined:
    // å¯åŠ¨MCPæœåŠ¡å™¨
    console.error('ğŸš€ å¯åŠ¨ CodeRocket MCP æœåŠ¡å™¨...');
    const serverPath = resolve(__dirname, '../dist/index.js');
    const server = spawn('node', [serverPath], {
      stdio: 'inherit',
      env: process.env,
    });
    
    server.on('error', (error) => {
      console.error('âŒ æœåŠ¡å™¨å¯åŠ¨å¤±è´¥:', error.message);
      process.exit(1);
    });
    
    server.on('exit', (code) => {
      if (code !== 0) {
        console.error(`âŒ æœåŠ¡å™¨å¼‚å¸¸é€€å‡ºï¼Œä»£ç : ${code}`);
        process.exit(code || 1);
      }
    });
    break;

  case 'test':
    // è¿è¡Œæµ‹è¯•
    console.error('ğŸ§ª è¿è¡Œ CodeRocket MCP æµ‹è¯•...');
    const testPath = resolve(__dirname, '../dist/test.js');
    const test = spawn('node', [testPath], {
      stdio: 'inherit',
      env: process.env,
    });
    
    test.on('error', (error) => {
      console.error('âŒ æµ‹è¯•è¿è¡Œå¤±è´¥:', error.message);
      process.exit(1);
    });
    
    test.on('exit', (code) => {
      process.exit(code || 0);
    });
    break;

  case 'help':
  case '--help':
  case '-h':
    console.log(`
CodeRocket MCP - AIé©±åŠ¨çš„ä»£ç å®¡æŸ¥æœåŠ¡å™¨

ç”¨æ³•:
  coderocket-mcp [å‘½ä»¤]

å‘½ä»¤:
  start, (é»˜è®¤)    å¯åŠ¨MCPæœåŠ¡å™¨
  test             è¿è¡ŒåŠŸèƒ½æµ‹è¯•
  help             æ˜¾ç¤ºå¸®åŠ©ä¿¡æ¯

ç¤ºä¾‹:
  coderocket-mcp start     # å¯åŠ¨æœåŠ¡å™¨
  coderocket-mcp test      # è¿è¡Œæµ‹è¯•
  coderocket-mcp help      # æ˜¾ç¤ºå¸®åŠ©

ç¯å¢ƒå˜é‡:
  AI_SERVICE              é»˜è®¤AIæœåŠ¡ (gemini/opencode/claudecode)
  AI_AUTO_SWITCH          å¯ç”¨è‡ªåŠ¨åˆ‡æ¢ (true/false)
  AI_TIMEOUT              è¶…æ—¶æ—¶é—´ï¼ˆç§’ï¼‰
  AI_MAX_RETRIES          æœ€å¤§é‡è¯•æ¬¡æ•°
  NODE_ENV                ç¯å¢ƒæ¨¡å¼ (development/production)

æ›´å¤šä¿¡æ¯è¯·è®¿é—®: https://github.com/im47cn/coderocket-cli
`);
    break;

  case 'version':
  case '--version':
  case '-v':
    // è¯»å–package.jsonè·å–ç‰ˆæœ¬ä¿¡æ¯
    try {
      const packagePath = resolve(__dirname, '../package.json');
      const packageJson = JSON.parse(
        require('fs').readFileSync(packagePath, 'utf-8')
      );
      console.log(`CodeRocket MCP v${packageJson.version}`);
    } catch (error) {
      console.log('CodeRocket MCP v1.0.0');
    }
    break;

  default:
    console.error(`âŒ æœªçŸ¥å‘½ä»¤: ${command}`);
    console.error('ä½¿ç”¨ "coderocket-mcp help" æŸ¥çœ‹å¯ç”¨å‘½ä»¤');
    process.exit(1);
}
