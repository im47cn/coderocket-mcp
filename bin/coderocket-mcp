#!/usr/bin/env node

/**
 * CodeRocket MCP 独立启动脚本
 *
 * 符合 MCP 标准，直接启动服务器，无需额外参数
 */

import { resolve, dirname } from 'path';
import { fileURLToPath } from 'url';
import { readFileSync } from 'fs';

const __filename = fileURLToPath(import.meta.url);
const __dirname = dirname(__filename);

const command = process.argv[2];

// 如果没有命令或命令是 start，直接启动 MCP 服务器
if (!command || command === 'start') {
  // 直接导入并启动 MCP 服务器（不使用 spawn）
  const serverPath = resolve(__dirname, '../dist/index.js');

  try {
    // 动态导入服务器模块并启动
    import(serverPath).catch((error) => {
      console.error('❌ CodeRocket MCP 服务器启动失败:', error.message);
      process.exit(1);
    });
  } catch (error) {
    console.error('❌ 无法加载 CodeRocket MCP 服务器:', error.message);
    process.exit(1);
  }
} else {
  // 处理其他命令
  switch (command) {

    case 'test':
      // 运行测试
      console.error('🧪 运行 CodeRocket MCP 测试...');
      const testPath = resolve(__dirname, '../dist/test.js');

      try {
        import(testPath).catch((error) => {
          console.error('❌ 测试运行失败:', error.message);
          process.exit(1);
        });
      } catch (error) {
        console.error('❌ 无法加载测试模块:', error.message);
        process.exit(1);
      }
      break;

    case 'help':
    case '--help':
    case '-h':
      console.log(`
CodeRocket MCP - 独立的AI驱动代码审查服务器

用法:
  npx @yeepay/coderocket-mcp [命令]

命令:
  (默认)               启动MCP服务器
  test                 运行功能测试
  help                 显示帮助信息
  version              显示版本信息

示例:
  npx @yeepay/coderocket-mcp        # 启动服务器
  npx @yeepay/coderocket-mcp test   # 运行测试
  npx @yeepay/coderocket-mcp help   # 显示帮助

环境变量配置:
  AI_SERVICE              默认AI服务 (gemini/claudecode)
  AI_AUTO_SWITCH          启用自动切换 (true/false)
  AI_TIMEOUT              超时时间（秒，默认30）
  AI_MAX_RETRIES          最大重试次数（默认3）
  GEMINI_API_KEY          Gemini API密钥
  CLAUDECODE_API_KEY      ClaudeCode API密钥
  NODE_ENV                环境模式 (development/production)
  DEBUG                   调试模式 (true/false)

配置文件:
  项目级: .env
  全局级: ~/.coderocket/env

更多信息请访问: https://github.com/im47cn/coderocket-mcp
`);
      break;

    case 'version':
    case '--version':
    case '-v':
      // 读取package.json获取版本信息
      try {
        const packagePath = resolve(__dirname, '../package.json');
        const packageJson = JSON.parse(
          readFileSync(packagePath, 'utf-8')
        );
        console.log(`CodeRocket MCP v${packageJson.version}`);
        console.log(`独立版本 - 无需 coderocket-cli 依赖`);
      } catch (error) {
        console.log('CodeRocket MCP v1.0.1 (独立版本)');
      }
      break;

    default:
      console.error(`❌ 未知命令: ${command}`);
      console.error('使用 "npx @yeepay/coderocket-mcp help" 查看可用命令');
      process.exit(1);
  }
}
