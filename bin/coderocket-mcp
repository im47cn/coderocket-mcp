#!/usr/bin/env node

/**
 * CodeRocket MCP ç‹¬ç«‹å¯åŠ¨è„šæœ¬
 *
 * ç¬¦åˆ MCP æ ‡å‡†ï¼Œç›´æ¥å¯åŠ¨æœåŠ¡å™¨ï¼Œæ— éœ€é¢å¤–å‚æ•°
 */

import { resolve, dirname } from 'path';
import { fileURLToPath } from 'url';
import { readFileSync } from 'fs';

const __filename = fileURLToPath(import.meta.url);
const __dirname = dirname(__filename);

const command = process.argv[2];

// å¤„ç†å·¥å…·è°ƒç”¨å‘½ä»¤ï¼ˆå¦‚ review_changes, review_commit ç­‰ï¼‰
if (command && ['review_changes', 'review_commit', 'review_code', 'review_files', 'get_ai_service_status', 'configure_ai_service'].includes(command)) {
  const toolArgs = process.argv.slice(3);

  async function runTool() {
    try {
      console.log('ğŸ”§ æ­£åœ¨åˆå§‹åŒ–æœåŠ¡...');
      const coderocketModule = await import(resolve(__dirname, '../dist/coderocket.js'));
      console.log('âœ… æ¨¡å—å¯¼å…¥æˆåŠŸ');

      const { CodeRocketService, ConfigManager } = coderocketModule;
      console.log('âœ… ç±»å¯¼å…¥æˆåŠŸ');

      // åˆå§‹åŒ–é…ç½®ç®¡ç†å™¨
      await ConfigManager.initialize();
      console.log('âœ… é…ç½®ç®¡ç†å™¨åˆå§‹åŒ–å®Œæˆ');

      const service = new CodeRocketService();
      console.log(`ğŸš€ æ­£åœ¨æ‰§è¡Œå·¥å…·: ${command}`);

      let result;
      switch (command) {
        case 'review_changes':
          result = await service.reviewChanges({
            repository_path: toolArgs.find(arg => arg.startsWith('--path='))?.split('=')[1],
            ai_service: toolArgs.find(arg => arg.startsWith('--ai-service='))?.split('=')[1],
            custom_prompt: toolArgs.find(arg => arg.startsWith('--prompt='))?.split('=')[1],
            include_staged: !toolArgs.includes('--no-staged'),
            include_unstaged: !toolArgs.includes('--no-unstaged'),
          });
          break;
        case 'review_commit':
          result = await service.reviewCommit({
            repository_path: toolArgs.find(arg => arg.startsWith('--path='))?.split('=')[1],
            commit_hash: toolArgs.find(arg => arg.startsWith('--commit='))?.split('=')[1],
            ai_service: toolArgs.find(arg => arg.startsWith('--ai-service='))?.split('=')[1],
            custom_prompt: toolArgs.find(arg => arg.startsWith('--prompt='))?.split('=')[1],
          });
          break;
        case 'review_code':
          result = await service.reviewCode({
            code: toolArgs.find(arg => arg.startsWith('--code='))?.split('=')[1] || '',
            language: toolArgs.find(arg => arg.startsWith('--language='))?.split('=')[1],
            context: toolArgs.find(arg => arg.startsWith('--context='))?.split('=')[1],
            ai_service: toolArgs.find(arg => arg.startsWith('--ai-service='))?.split('=')[1],
            custom_prompt: toolArgs.find(arg => arg.startsWith('--prompt='))?.split('=')[1],
          });
          break;
        case 'review_files':
          const filesArg = toolArgs.find(arg => arg.startsWith('--files='))?.split('=')[1];
          const files = filesArg ? filesArg.split(',') : [];
          result = await service.reviewFiles({
            files,
            repository_path: toolArgs.find(arg => arg.startsWith('--path='))?.split('=')[1],
            ai_service: toolArgs.find(arg => arg.startsWith('--ai-service='))?.split('=')[1],
            custom_prompt: toolArgs.find(arg => arg.startsWith('--prompt='))?.split('=')[1],
          });
          break;
        case 'get_ai_service_status':
          console.log('ğŸ“Š æ­£åœ¨è·å–AIæœåŠ¡çŠ¶æ€...');
          result = await service.getAIServiceStatus();
          console.log('âœ… AIæœåŠ¡çŠ¶æ€è·å–å®Œæˆ');
          break;
        case 'configure_ai_service':
          result = await service.configureAIService({
            service: toolArgs.find(arg => arg.startsWith('--service='))?.split('=')[1] || 'gemini',
            api_key: toolArgs.find(arg => arg.startsWith('--api-key='))?.split('=')[1],
            scope: toolArgs.find(arg => arg.startsWith('--scope='))?.split('=')[1] || 'project',
            language: toolArgs.find(arg => arg.startsWith('--language='))?.split('=')[1],
            timeout: toolArgs.find(arg => arg.startsWith('--timeout='))?.split('=')[1] ?
              parseInt(toolArgs.find(arg => arg.startsWith('--timeout='))?.split('=')[1], 10) : undefined,
            max_retries: toolArgs.find(arg => arg.startsWith('--max-retries='))?.split('=')[1] ?
              parseInt(toolArgs.find(arg => arg.startsWith('--max-retries='))?.split('=')[1], 10) : undefined,
          });
          break;
        default:
          throw new Error(`å·¥å…· ${command} æš‚æœªå®ç°`);
      }

      // è¾“å‡ºç»“æœ
      if (typeof result === 'object') {
        console.log(JSON.stringify(result, null, 2));
      } else {
        console.log(result);
      }
    } catch (error) {
      console.error(`âŒ å·¥å…·æ‰§è¡Œå¤±è´¥: ${error.message}`);
      if (process.env.DEBUG === 'true') {
        console.error('ğŸ” è¯¦ç»†é”™è¯¯ä¿¡æ¯:', error);
      }
      process.exit(1);
    }
  }

  runTool();
}
// å¦‚æœæ²¡æœ‰å‘½ä»¤æˆ–å‘½ä»¤æ˜¯ startï¼Œç›´æ¥å¯åŠ¨ MCP æœåŠ¡å™¨
else if (!command || command === 'start') {
  // ç›´æ¥å¯¼å…¥å¹¶å¯åŠ¨ MCP æœåŠ¡å™¨ï¼ˆä¸ä½¿ç”¨ spawnï¼‰
  const serverPath = resolve(__dirname, '../dist/index.js');

  // ä½¿ç”¨ IIFE æ¥å¤„ç† async/await
  (async () => {
    try {
      await import(serverPath);
    } catch (error) {
      console.error('âŒ CodeRocket MCP æœåŠ¡å™¨å¯åŠ¨å¤±è´¥:', error.message);
      if (process.env.DEBUG === 'true') {
        console.error('ğŸ” è¯¦ç»†é”™è¯¯ä¿¡æ¯:', error);
      }
      process.exit(1);
    }
  })();
} else {
  // å¤„ç†å…¶ä»–å‘½ä»¤
  switch (command) {

    case 'test':
      // è¿è¡Œæµ‹è¯•
      console.error('ğŸ§ª è¿è¡Œ CodeRocket MCP æµ‹è¯•...');
      const testPath = resolve(__dirname, '../dist/test.js');

      try {
        import(testPath).catch((error) => {
          console.error('âŒ æµ‹è¯•è¿è¡Œå¤±è´¥:', error.message);
          process.exit(1);
        });
      } catch (error) {
        console.error('âŒ æ— æ³•åŠ è½½æµ‹è¯•æ¨¡å—:', error.message);
        process.exit(1);
      }
      break;

    case 'help':
    case '--help':
    case '-h':
      // æ˜¾ç¤ºå¸®åŠ©ä¿¡æ¯æ—¶ä¹Ÿæ˜¾ç¤º banner
      try {
        const bannerPath = resolve(__dirname, '../dist/banner.js');
        const { showMiniBanner } = await import(bannerPath);
        showMiniBanner();
        console.log('');
      } catch (error) {
        // å¦‚æœ banner åŠ è½½å¤±è´¥ï¼Œç»§ç»­æ˜¾ç¤ºå¸®åŠ©ä¿¡æ¯
        console.log('CodeRocket MCP - ç‹¬ç«‹çš„AIé©±åŠ¨ä»£ç å®¡æŸ¥æœåŠ¡å™¨');
        console.log('');
      }

      console.log(`ç”¨æ³•:
  npx @yeepay/coderocket-mcp [å‘½ä»¤]

å‘½ä»¤:
  (é»˜è®¤)               å¯åŠ¨MCPæœåŠ¡å™¨
  test                 è¿è¡ŒåŠŸèƒ½æµ‹è¯•
  help                 æ˜¾ç¤ºå¸®åŠ©ä¿¡æ¯
  version              æ˜¾ç¤ºç‰ˆæœ¬ä¿¡æ¯

ç¤ºä¾‹:
  npx @yeepay/coderocket-mcp        # å¯åŠ¨æœåŠ¡å™¨
  npx @yeepay/coderocket-mcp test   # è¿è¡Œæµ‹è¯•
  npx @yeepay/coderocket-mcp help   # æ˜¾ç¤ºå¸®åŠ©

ç¯å¢ƒå˜é‡é…ç½®:
  AI_SERVICE              é»˜è®¤AIæœåŠ¡ (gemini/claudecode)
  AI_AUTO_SWITCH          å¯ç”¨è‡ªåŠ¨åˆ‡æ¢ (true/false)
  AI_TIMEOUT              è¶…æ—¶æ—¶é—´ï¼ˆç§’ï¼Œé»˜è®¤30ï¼‰
  AI_MAX_RETRIES          æœ€å¤§é‡è¯•æ¬¡æ•°ï¼ˆé»˜è®¤3ï¼‰
  GEMINI_API_KEY          Gemini APIå¯†é’¥
  CLAUDECODE_API_KEY      ClaudeCode APIå¯†é’¥
  NODE_ENV                ç¯å¢ƒæ¨¡å¼ (development/production)
  DEBUG                   è°ƒè¯•æ¨¡å¼ (true/false)

é…ç½®æ–‡ä»¶:
  é¡¹ç›®çº§: .env
  å…¨å±€çº§: ~/.coderocket/env

æ›´å¤šä¿¡æ¯è¯·è®¿é—®: https://github.com/im47cn/coderocket-mcp
`);
      break;

    case 'version':
    case '--version':
    case '-v':
      // æ˜¾ç¤ºç‰ˆæœ¬ä¿¡æ¯æ—¶ä¹Ÿæ˜¾ç¤º banner
      try {
        // åŠ¨æ€å¯¼å…¥ banner æ¨¡å—
        const bannerPath = resolve(__dirname, '../dist/banner.js');
        const { showMiniBanner } = await import(bannerPath);

        showMiniBanner();
        console.log('');

        // è¯»å–package.jsonè·å–è¯¦ç»†ç‰ˆæœ¬ä¿¡æ¯
        const packagePath = resolve(__dirname, '../package.json');
        const packageJson = JSON.parse(
          readFileSync(packagePath, 'utf-8')
        );

        console.log(`ğŸ“¦ ç‰ˆæœ¬: v${packageJson.version}`);
        console.log(`ğŸ  å®‰è£…è·¯å¾„: ${resolve(__dirname, '..')}`);
        console.log(`ğŸ”— NPMåŒ…: @yeepay/coderocket-mcp`);
        console.log(`ğŸ“š æ–‡æ¡£: https://github.com/im47cn/coderocket-mcp`);

      } catch (error) {
        console.error('âš ï¸ æ— æ³•è¯»å–ç‰ˆæœ¬ä¿¡æ¯:', error.message);
        console.error('ğŸ“ å°è¯•çš„è·¯å¾„:', resolve(__dirname, '../package.json'));
        console.log('CodeRocket MCP');
        console.log('ğŸ’¡ è¿è¡Œ "npm view @yeepay/coderocket-mcp version" æŸ¥çœ‹æœ€æ–°ç‰ˆæœ¬');
      }
      break;

    default:
      console.error(`âŒ æœªçŸ¥å‘½ä»¤: ${command}`);
      console.error('ä½¿ç”¨ "npx @yeepay/coderocket-mcp help" æŸ¥çœ‹å¯ç”¨å‘½ä»¤');
      process.exit(1);
  }
}
